// Generated by CoffeeScript 1.3.3
(function() {
  var AreaSummary, CustomMap, MapApp, extractUrlParams, markersOptionsMenu,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  markersOptionsMenu = $('#markers-options');

  MapApp = {
    toggleMarkersOptionsMenu: function() {
      return markersOptionsMenu.toggleClass('active');
    },
    hideMarkersOptionsMenu: function() {
      return markersOptionsMenu.addClass('off');
    },
    showMarkersOptionsMenu: function() {
      return markersOptionsMenu.removeClass('off');
    }
  };

  CustomMap = (function() {

    function CustomMap(id) {
      this.toggleMarkerList = __bind(this.toggleMarkerList, this);

      this.handleExport = __bind(this.handleExport, this);

      this.handleMarkerRemovalTool = __bind(this.handleMarkerRemovalTool, this);

      this.handleDevMod = __bind(this.handleDevMod, this);

      var _this = this;
      this.blankTilePath = 'tiles/00empty.jpg';
      this.iconsPath = 'assets/images/icons/32x32';
      this.maxZoom = 7;
      this.lngContainer = $('#long');
      this.latContainer = $('#lat');
      this.devModInput = $('#dev-mod');
      this.optionsBox = $('#options-box');
      this.addMarkerLink = $('#add-marker');
      this.removeMarkerLink = $('#remove-marker');
      this.markerList = $('#marker-list');
      this.exportBtn = $('#export');
      this.exportWindow = $('#export-windows');
      this.defaultLat = 25.760319754713887;
      this.defaultLng = -35.6396484375;
      this.areaSummaryBoxes = [];
      this.canRemoveMarker = false;
      this.draggableMarker = false;
      this.visibleMarkers = true;
      this.canToggleMarkers = true;
      this.gMapOptions = {
        center: new google.maps.LatLng(this.getStartLat(), this.getStartLng()),
        zoom: 6,
        minZoom: 3,
        maxZoom: this.maxZoom,
        streetViewControl: false,
        mapTypeControl: false,
        mapTypeControlOptions: {
          mapTypeIds: ["custom", google.maps.MapTypeId.ROADMAP]
        },
        panControl: false,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.LEFT_CENTER,
          zoomControlStyle: google.maps.ZoomControlStyle.SMALL
        }
      };
      this.customMapType = new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
          var normalizedCoord, path;
          normalizedCoord = coord;
          if (normalizedCoord && (normalizedCoord.x < Math.pow(2, zoom)) && (normalizedCoord.x > -1) && (normalizedCoord.y < Math.pow(2, zoom)) && (normalizedCoord.y > -1)) {
            return path = 'tiles/' + zoom + '_' + normalizedCoord.x + '_' + normalizedCoord.y + '.jpg';
          } else {
            return _this.blankTilePath;
          }
        },
        tileSize: new google.maps.Size(256, 256),
        maxZoom: this.maxZoom,
        name: 'GW2 Map'
      });
      this.map = new google.maps.Map($(id)[0], this.gMapOptions);
      this.map.mapTypes.set('custom', this.customMapType);
      this.map.setMapTypeId('custom');
      this.addMenuIcons();
      google.maps.event.addListener(this.map, 'mousemove', function(e) {
        _this.lngContainer.html(e.latLng.lng());
        return _this.latContainer.html(e.latLng.lat());
      });
      google.maps.event.addListener(this.map, 'click', function(e) {
        return console.log("Long: " + (e.latLng.lng()) + ", Lat: " + (e.latLng.lat()));
      });
      google.maps.event.addListener(this.map, 'zoom_changed', function(e) {
        var zoomLevel;
        zoomLevel = _this.map.getZoom();
        if (zoomLevel === 4) {
          _this.canToggleMarkers = false;
          MapApp.hideMarkersOptionsMenu();
          _this.setAllMarkersVisibility(false);
          return _this.setAreasInformationVisibility(true);
        } else if (zoomLevel > 4) {
          _this.canToggleMarkers = true;
          MapApp.showMarkersOptionsMenu();
          _this.setAllMarkersVisibility(true);
          return _this.setAreasInformationVisibility(false);
        } else if (zoomLevel < 4) {
          _this.canToggleMarkers = false;
          MapApp.hideMarkersOptionsMenu();
          _this.setAllMarkersVisibility(false);
          return _this.setAreasInformationVisibility(false);
        }
      });
      this.devModInput.bind('click', this.handleDevMod);
      this.gMarker = {};
      this.setAllMarkers();
      this.initializeAreaSummaryBoxes();
      this.markerList.find('span').bind('click', function(e) {
        var coord, img, markerType, markerinfo, this_;
        this_ = $(e.currentTarget);
        markerType = this_.attr('data-type');
        coord = _this.map.getCenter();
        markerinfo = {
          "lng": coord.lng(),
          "lat": coord.lat(),
          "title": "--"
        };
        img = "" + _this.iconsPath + "/" + markerType + ".png";
        return _this.addMarkers(markerinfo, img, markerType);
      });
      this.addMarkerLink.bind('click', this.toggleMarkerList);
      this.removeMarkerLink.bind('click', this.handleMarkerRemovalTool);
      this.exportBtn.bind('click', this.handleExport);
      this.exportWindow.find('.close').click(function() {
        return _this.exportWindow.hide();
      });
    }

    CustomMap.prototype.addMarker = function(markerInfo, type) {
      var iconmid, iconsize, image, infoWindow, marker, permalink, test,
        _this = this;
      iconsize = 32;
      iconmid = iconsize / 2;
      image = new google.maps.MarkerImage(this.getIconURLByType(type), null, null, new google.maps.Point(iconmid, iconmid), new google.maps.Size(iconsize, iconsize));
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(markerInfo.lat, markerInfo.lng),
        map: this.map,
        icon: image,
        draggable: this.draggableMarker,
        cursor: this.draggableMarker ? "move" : "pointer",
        title: "" + markerInfo.title
      });
      permalink = '<p class="marker-permalink"><a href="?lat=' + markerInfo.lat + '&lng=' + markerInfo.lng + '">Permalink</a></p>';
      infoWindow = new google.maps.InfoWindow({
        content: (("" + markerInfo.desc) === "" ? "More info comming soon" : "" + markerInfo.desc) + "<p>" + permalink + "</p>",
        maxWidth: 200
      });
      marker["title"] = "" + markerInfo.title;
      marker["desc"] = "" + markerInfo.desc;
      marker["infoWindow"] = infoWindow;
      test = this.getMarkerByCoordinates(this.getStartLat(), this.getStartLng());
      if (test === markerInfo) {
        marker.infoWindow.open(this.map, marker);
        this.currentOpenedInfoWindow = marker.infoWindow;
      }
      google.maps.event.addListener(marker, 'dragend', function(e) {
        return console.log("" + (e.latLng.lat()) + ", " + (e.latLng.lng()));
      });
      google.maps.event.addListener(marker, 'click', function(e) {
        if (_this.canRemoveMarker && _this.draggableMarker) {
          return _this.removeMarker(marker.__gm_id);
        } else {
          if (_this.currentOpenedInfoWindow) {
            _this.currentOpenedInfoWindow.close();
          }
          marker.infoWindow.open(_this.map, marker);
          return _this.currentOpenedInfoWindow = marker.infoWindow;
        }
      });
      if (!this.gMarker[type]) {
        this.gMarker[type] = [];
      }
      return this.gMarker[type].push(marker);
    };

    CustomMap.prototype.setAllMarkers = function() {
      var marker, markerArray, type, _results;
      _results = [];
      for (type in Markers) {
        markerArray = Markers[type];
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = markerArray.length; _i < _len; _i++) {
            marker = markerArray[_i];
            _results1.push(this.addMarker(marker, type));
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    CustomMap.prototype.getIconURLByType = function(type) {
      var icon;
      for (icon in Resources.Icons) {
        if (icon === type) {
          return Resources.Icons[icon].url;
        }
      }
    };

    CustomMap.prototype.setAllMarkersVisibility = function(isVisible) {
      var type, _results;
      _results = [];
      for (type in Markers) {
        if (!$("[data-type='" + type + "']").hasClass('hidden')) {
          _results.push(this.setMarkersVisibilityByType(isVisible, type));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    CustomMap.prototype.setMarkersVisibilityByType = function(isVisible, type) {
      var marker, _i, _len, _ref, _results;
      _ref = this.gMarker[type];
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        marker = _ref[_i];
        _results.push(marker.setVisible(isVisible));
      }
      return _results;
    };

    CustomMap.prototype.handleDevMod = function(e) {
      var this_;
      this_ = $(e.currentTarget);
      if (this_.prop('checked')) {
        this.setDraggableMarker(true);
        return this.optionsBox.addClass('active');
      } else {
        this.setDraggableMarker(false);
        this.optionsBox.removeClass('active');
        this.markerList.removeClass('active');
        return this.addMarkerLink.removeClass('active');
      }
    };

    CustomMap.prototype.handleMarkerRemovalTool = function(e) {
      if (this.removeMarkerLink.hasClass('active')) {
        this.removeMarkerLink.removeClass('active');
        this.optionsBox.removeClass('red');
        return this.canRemoveMarker = false;
      } else {
        this.removeMarkerLink.addClass('active');
        this.optionsBox.addClass('red');
        this.canRemoveMarker = true;
        this.markerList.removeClass('active');
        return this.addMarkerLink.removeClass('active');
      }
    };

    CustomMap.prototype.handleExport = function(e) {
      var jsonString, marker, markerObject, markers, markersId, nm, _i, _len, _ref;
      markerObject = {};
      _ref = this.gMarker;
      for (markersId in _ref) {
        markers = _ref[markersId];
        if (!markerObject[markersId]) {
          markerObject[markersId] = [];
        }
        for (_i = 0, _len = markers.length; _i < _len; _i++) {
          marker = markers[_i];
          nm = {
            "lng": marker.getPosition().lng(),
            "lat": marker.getPosition().lat(),
            "title": marker.title,
            "desc": marker.desc
          };
          markerObject[markersId].push(nm);
        }
      }
      jsonString = JSON.stringify(markerObject);
      this.exportWindow.find('.content').html(jsonString);
      return this.exportWindow.show();
    };

    CustomMap.prototype.getStartLat = function() {
      var params;
      params = extractUrlParams();
      if ((params['lat'] != null)) {
        return params['lat'];
      } else {
        return this.defaultLat;
      }
    };

    CustomMap.prototype.getStartLng = function() {
      var params;
      params = extractUrlParams();
      if ((params['lng'] != null)) {
        return params['lng'];
      } else {
        return this.defaultLng;
      }
    };

    CustomMap.prototype.removeMarker = function(id) {
      var marker, markers, markersId, _ref, _results,
        _this = this;
      _ref = this.gMarker;
      _results = [];
      for (markersId in _ref) {
        markers = _ref[markersId];
        this.gMarker[markersId] = _.reject(markers, function(m) {
          return m.__gm_id === id;
        });
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = markers.length; _i < _len; _i++) {
            marker = markers[_i];
            if (marker.__gm_id === id) {
              _results1.push(marker.setMap(null));
            } else {
              _results1.push(void 0);
            }
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.setDraggableMarker = function(val) {
      var marker, markers, markersId, _ref, _results;
      this.draggableMarker = val;
      _ref = this.gMarker;
      _results = [];
      for (markersId in _ref) {
        markers = _ref[markersId];
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = markers.length; _i < _len; _i++) {
            marker = markers[_i];
            marker.setDraggable(val);
            if (val) {
              _results1.push(marker.setCursor('move'));
            } else {
              _results1.push(marker.setCursor('pointer'));
            }
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.hideAllMarker = function() {
      var marker, markers, markersId, _ref, _results;
      _ref = this.gMarker;
      _results = [];
      for (markersId in _ref) {
        markers = _ref[markersId];
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = markers.length; _i < _len; _i++) {
            marker = markers[_i];
            _results1.push(marker.setVisible(false));
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.showAllMarker = function() {
      var marker, markers, markersId, _ref, _results;
      _ref = this.gMarker;
      _results = [];
      for (markersId in _ref) {
        markers = _ref[markersId];
        _results.push((function() {
          var _i, _len, _results1;
          _results1 = [];
          for (_i = 0, _len = markers.length; _i < _len; _i++) {
            marker = markers[_i];
            _results1.push(marker.setVisible(true));
          }
          return _results1;
        })());
      }
      return _results;
    };

    CustomMap.prototype.toggleMarkerList = function(e) {
      var this_;
      this_ = $(e.currentTarget);
      this.markerList.toggleClass('active');
      this_.toggleClass('active');
      if (this_.hasClass('active')) {
        this.removeMarkerLink.removeClass('active');
        this.optionsBox.removeClass('red');
        return this.canRemoveMarker = false;
      }
    };

    CustomMap.prototype.getMarkerByCoordinates = function(lat, lng) {
      var marker, markerType, type, _i, _len;
      for (type in Markers) {
        markerType = Markers[type];
        for (_i = 0, _len = markerType.length; _i < _len; _i++) {
          marker = markerType[_i];
          if (lat === marker.lat && lng === marker.lng) {
            return marker;
          }
        }
      }
      return false;
    };

    CustomMap.prototype.addMenuIcons = function() {
      var icon, img, li, type, _ref, _results,
        _this = this;
      _ref = Resources.Icons;
      _results = [];
      for (type in _ref) {
        icon = _ref[type];
        li = $("<li></li>");
        img = $("<img>", {
          src: icon.url,
          alt: type
        });
        li.append(img);
        li.attr('data-type', type);
        li.bind('click', function(e) {
          var item;
          item = e.currentTarget;
          console.log(_this.canToggleMarkers);
          if (_this.canToggleMarkers) {
            if (item.getAttribute('class') === 'hidden') {
              _this.setMarkersVisibilityByType(true, item.getAttribute('data-type'));
              return e.currentTarget.setAttribute('class', '');
            } else {
              _this.setMarkersVisibilityByType(false, item.getAttribute('data-type'));
              return e.currentTarget.setAttribute('class', 'hidden');
            }
          }
        });
        _results.push($('#menu-marker ul').append(li));
      }
      return _results;
    };

    CustomMap.prototype.initializeAreaSummaryBoxes = function() {
      var area, _results;
      _results = [];
      for (area in Areas) {
        _results.push(this.areaSummaryBoxes[area] = new AreaSummary(this.map, Areas[area]));
      }
      return _results;
    };

    CustomMap.prototype.setAreasInformationVisibility = function(isVisible) {
      var box, _i, _len, _ref, _results;
      _ref = this.areaSummaryBoxes;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        box = _ref[_i];
        _results.push(box.setVisible(isVisible));
      }
      return _results;
    };

    return CustomMap;

  })();

  AreaSummary = (function() {

    function AreaSummary(map, area) {
      var neBound, swBound;
      swBound = new google.maps.LatLng(area.swLat, area.swLng);
      neBound = new google.maps.LatLng(area.neLat, area.neLng);
      this.bounds_ = new google.maps.LatLngBounds(swBound, neBound);
      this.area_ = area;
      this.div_ = null;
      this.height_ = 80;
      this.width_ = 150;
      this.setMap(map);
    }

    AreaSummary.prototype = new google.maps.OverlayView();

    AreaSummary.prototype.onAdd = function() {
      var div, img, li, panes, rangeLvl, title, type, ul;
      div = $('<div class="area-summary-overlay"></div>');
      title = $('<p class="area-summary-title"></p>');
      if (this.area_.rangeLvl !== "") {
        rangeLvl = "<span class='lvl-range'>(" + this.area_.rangeLvl + ")</span>";
      } else {
        div.addClass('city');
        rangeLvl = "";
      }
      title.html("<span class='area-title'>" + this.area_.name + "</span>" + rangeLvl);
      div.append(title);
      ul = $('<ul class="area-summary-list"></ul>');
      for (type in this.area_.summary) {
        if (this.area_.summary[type] > 0) {
          li = $('<li></li>');
          img = $('<img class="area-summary-icons">');
          img.attr('src', Resources.Icons[type].url);
          img.attr('alt', Resources.Icons[type].label);
          img.attr('width', "15px");
          img.attr('height', "15px");
          li.append(img);
          li.append(this.area_.summary[type]);
          ul.append(li);
        }
      }
      div.append(ul);
      this.div_ = div[0];
      panes = this.getPanes();
      panes.overlayImage.appendChild(this.div_);
      return this.setVisible(false);
    };

    AreaSummary.prototype.draw = function() {
      var div, ne, overlayProjection, sw;
      overlayProjection = this.getProjection();
      sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
      ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());
      div = this.div_;
      div.style.left = sw.x + ((ne.x - sw.x) - this.width_) / 2 + 'px';
      return div.style.top = ne.y + ((sw.y - ne.y) - this.height_) / 2 + 'px';
    };

    AreaSummary.prototype.setVisible = function(isVisible) {
      if (this.div_) {
        if (isVisible === true) {
          return this.div_.style.visibility = "visible";
        } else {
          return this.div_.style.visibility = "hidden";
        }
      }
    };

    return AreaSummary;

  })();

  extractUrlParams = function() {
    var element, f, parameters, x, _i, _len;
    parameters = location.search.substring(1).split('&');
    f = [];
    for (_i = 0, _len = parameters.length; _i < _len; _i++) {
      element = parameters[_i];
      x = element.split('=');
      f[x[0]] = x[1];
    }
    return f;
  };

  $(function() {
    var markersOptionsMenuToggle, myCustomMap;
    myCustomMap = new CustomMap('#map');
    markersOptionsMenuToggle = $('#options-toggle strong');
    return markersOptionsMenuToggle.click(function() {
      return MapApp.toggleMarkersOptionsMenu();
    });
  });

}).call(this);
